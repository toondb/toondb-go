name: Release Go SDK

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Go SDK version to release (e.g., 0.4.1)'
        required: true
        type: string
      sochdb_version:
        description: 'SochDB binary version (e.g., 0.4.3) - MUST match an existing sochdb/sochdb release tag'
        required: false
        type: string
  # Automatic trigger on version tags
  push:
    tags:
      - 'v*.*.*'

env:
  SOCHDB_REPO: sochdb/sochdb

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SDK_VERSION="${{ github.event.inputs.version }}"
            # Use sochdb_version if provided, otherwise use SDK version
            SOCHDB_VERSION="${{ github.event.inputs.sochdb_version }}"
            if [ -z "$SOCHDB_VERSION" ]; then
              SOCHDB_VERSION="$SDK_VERSION"
            fi
          else
            # Extract version from tag (remove 'v' prefix)
            SDK_VERSION="${GITHUB_REF#refs/tags/v}"
            SOCHDB_VERSION="$SDK_VERSION"
          fi
          echo "sdk_version=$SDK_VERSION" >> $GITHUB_OUTPUT
          echo "sochdb_version=$SOCHDB_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$SDK_VERSION" >> $GITHUB_OUTPUT
          echo "sochdb_tag=v$SOCHDB_VERSION" >> $GITHUB_OUTPUT
          echo "Using Go SDK version: $SDK_VERSION"
          echo "Using SochDB binary version: $SOCHDB_VERSION"

      - name: Create bin directories
        run: |
          mkdir -p bin/darwin-arm64
          mkdir -p bin/linux-amd64
          mkdir -p bin/windows-amd64

      - name: Download macOS ARM64 binaries
        run: |
          ASSET_NAME="sochdb-${{ steps.version.outputs.sochdb_version }}-aarch64-apple-darwin.tar.gz"
          DOWNLOAD_URL="https://github.com/${{ env.SOCHDB_REPO }}/releases/download/${{ steps.version.outputs.sochdb_tag }}/${ASSET_NAME}"
          echo "Downloading from: $DOWNLOAD_URL"
          
          curl -L -f -o darwin-arm64.tar.gz "$DOWNLOAD_URL"
          tar -xzf darwin-arm64.tar.gz
          
          # Move binaries to bin directory
          mv sochdb-server bin/darwin-arm64/ 2>/dev/null || true
          mv sochdb-grpc-server bin/darwin-arm64/ 2>/dev/null || true
          mv sochdb-bulk bin/darwin-arm64/ 2>/dev/null || true
          
          # Also check if they're in a subdirectory
          find . -maxdepth 2 -name "sochdb-server" -type f -exec mv {} bin/darwin-arm64/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "sochdb-grpc-server" -type f -exec mv {} bin/darwin-arm64/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "sochdb-bulk" -type f -exec mv {} bin/darwin-arm64/ \; 2>/dev/null || true
          # Libraries (for Embedded Mode)
          find . -maxdepth 2 -name "libsochdb_storage.dylib" -type f -exec mv {} bin/darwin-arm64/ \; 2>/dev/null || true
          
          rm -f darwin-arm64.tar.gz
          ls -la bin/darwin-arm64/

      - name: Download Linux x86_64 binaries
        run: |
          ASSET_NAME="sochdb-${{ steps.version.outputs.sochdb_version }}-x86_64-unknown-linux-gnu.tar.gz"
          DOWNLOAD_URL="https://github.com/${{ env.SOCHDB_REPO }}/releases/download/${{ steps.version.outputs.sochdb_tag }}/${ASSET_NAME}"
          echo "Downloading from: $DOWNLOAD_URL"
          
          curl -L -f -o linux-amd64.tar.gz "$DOWNLOAD_URL"
          tar -xzf linux-amd64.tar.gz
          
          # Setup native libs for CGO (required for go build)
          mkdir -p ../sochdb/target/release
          find . -name "libsochdb_storage.so" -type f -exec cp {} ../sochdb/target/release/ \;
          # Also package in release
          find . -name "libsochdb_storage.so" -type f -exec cp {} bin/linux-amd64/ \;
          
          # Also ensure include dir exists to prevent CFLAGS warning/error
          mkdir -p include
          
          # Move binaries to bin directory
          mv sochdb-server bin/linux-amd64/ 2>/dev/null || true
          mv sochdb-grpc-server bin/linux-amd64/ 2>/dev/null || true
          mv sochdb-bulk bin/linux-amd64/ 2>/dev/null || true
          
          # Also check if they're in a subdirectory
          find . -maxdepth 2 -name "sochdb-server" -type f -exec mv {} bin/linux-amd64/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "sochdb-grpc-server" -type f -exec mv {} bin/linux-amd64/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "sochdb-bulk" -type f -exec mv {} bin/linux-amd64/ \; 2>/dev/null || true
          
          rm -f linux-amd64.tar.gz
          ls -la bin/linux-amd64/

      - name: Download Windows x86_64 binaries
        run: |
          ASSET_NAME="sochdb-${{ steps.version.outputs.sochdb_version }}-x86_64-pc-windows-msvc.zip"
          DOWNLOAD_URL="https://github.com/${{ env.SOCHDB_REPO }}/releases/download/${{ steps.version.outputs.sochdb_tag }}/${ASSET_NAME}"
          echo "Downloading from: $DOWNLOAD_URL"
          
          curl -L -f -o windows-amd64.zip "$DOWNLOAD_URL"
          unzip -o windows-amd64.zip
          
          # Move binaries to bin directory
          mv sochdb-server.exe bin/windows-amd64/ 2>/dev/null || true
          mv sochdb-grpc-server.exe bin/windows-amd64/ 2>/dev/null || true
          mv sochdb-bulk.exe bin/windows-amd64/ 2>/dev/null || true
          
          # Also check if they're in a subdirectory
          find . -maxdepth 2 -name "sochdb-server.exe" -type f -exec mv {} bin/windows-amd64/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "sochdb-grpc-server.exe" -type f -exec mv {} bin/windows-amd64/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "sochdb-bulk.exe" -type f -exec mv {} bin/windows-amd64/ \; 2>/dev/null || true
          # Libraries (for Embedded Mode)
          find . -maxdepth 2 -name "sochdb_storage.dll" -type f -exec mv {} bin/windows-amd64/ \; 2>/dev/null || true
          
          rm -f windows-amd64.zip
          ls -la bin/windows-amd64/

      - name: Update version in sochdb.go
        run: |
          VERSION="${{ steps.version.outputs.sdk_version }}"
          if grep -q 'const Version' sochdb.go; then
            sed -i "s/const Version = \".*\"/const Version = \"$VERSION\"/" sochdb.go
          fi
          cat sochdb.go | grep -A1 "Version" || true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Verify Go module
        run: |
          go mod tidy
          # Skip embedded package and examples in CI - they require native library
          go build $(go list ./... | grep -v '/embedded' | grep -v '/examples')

      - name: Clean up extracted files
        run: |
          # Remove extracted platform directories that came from the tarballs
          rm -rf aarch64-apple-darwin x86_64-unknown-linux-gnu x86_64-pc-windows-msvc
          # Remove any stray libraries
          rm -f *.dylib *.so *.dll 2>/dev/null || true

      - name: Create release archive
        run: |
          VERSION="${{ steps.version.outputs.sdk_version }}"
          
          # Create archive in /tmp to avoid "file changed" error
          tar -czvf /tmp/sochdb-go-${VERSION}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='aarch64-apple-darwin' \
            --exclude='x86_64-unknown-linux-gnu' \
            --exclude='x86_64-pc-windows-msvc' \
            .
          
          # Move to current directory
          mv /tmp/sochdb-go-${VERSION}.tar.gz .
          
          # List contents
          echo "Archive contents:"
          tar -tzvf sochdb-go-${VERSION}.tar.gz | head -50

      - name: Generate release notes
        id: notes
        run: |
          SDK_VERSION="${{ steps.version.outputs.sdk_version }}"
          SOCHDB_VERSION="${{ steps.version.outputs.sochdb_version }}"
          cat << 'EOF' > release_notes.md
          ## SochDB Go SDK v${{ steps.version.outputs.sdk_version }}
          
          **Bundled with SochDB binaries v${{ steps.version.outputs.sochdb_version }}**
          
          ### Installation
          
          ```bash
          go get github.com/sochdb/sochdb-go@v${{ steps.version.outputs.sdk_version }}
          ```
          
          ### Bundled Binaries
          
          This release includes pre-built SochDB server binaries (v${{ steps.version.outputs.sochdb_version }}) for:
          - **macOS ARM64** (Apple Silicon) - `bin/darwin-arm64/`
          - **Linux x86_64** - `bin/linux-amd64/`
          - **Windows x64** - `bin/windows-amd64/`
          
          The binaries are automatically extracted and used when you create a new SochDB instance.
          
          ### Binary Contents
          
          Each platform includes:
          - `sochdb-server` - Main database server
          - `sochdb-grpc-server` - gRPC server for remote connections
          - `sochdb-bulk` - Bulk import/export utility
          
          ### Changes
          
          See the [main SochDB changelog](https://github.com/sochdb/sochdb/blob/main/CHANGELOG.md) for binary details.
          EOF

      - name: Create or update tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          
          # Configure git identity
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Delete existing tag if it exists (for re-releases)
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" 2>/dev/null || true
          
          # Create new tag
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: SochDB Go SDK ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          files: |
            sochdb-go-${{ steps.version.outputs.sdk_version }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
